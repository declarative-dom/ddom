<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DDOM Request Test</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .test-section { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .status { padding: 5px 10px; margin: 5px 0; border-radius: 3px; }
        .pass { background: #d4edda; color: #155724; }
        .fail { background: #f8d7da; color: #721c24; }
        pre { background: white; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>DDOM Request Feature Test</h1>
    
    <div class="test-section">
        <h2>Test 1: Basic Library Loading</h2>
        <div id="test1-status" class="status">Testing...</div>
        <pre id="test1-details"></pre>
    </div>
    
    <div class="test-section">
        <h2>Test 2: Request Detection</h2>
        <div id="test2-status" class="status">Testing...</div>
        <pre id="test2-details"></pre>
    </div>
    
    <div class="test-section">
        <h2>Test 3: Simple Fetch Signal</h2>
        <div id="test3-status" class="status">Testing...</div>
        <pre id="test3-details"></pre>
    </div>
    
    <div class="test-section">
        <h2>Test 4: Declarative Element with Request</h2>
        <div id="test4-status" class="status">Testing...</div>
        <pre id="test4-details"></pre>
        <div id="test4-demo"></div>
    </div>
    
    <script type="module">
        import DDOM from '../lib/dist/index.js';
        
        // Test utilities
        function pass(testId, message, details) {
            document.getElementById(`${testId}-status`).className = 'status pass';
            document.getElementById(`${testId}-status`).textContent = `✓ PASS: ${message}`;
            if (details) document.getElementById(`${testId}-details`).textContent = details;
        }
        
        function fail(testId, message, details) {
            document.getElementById(`${testId}-status`).className = 'status fail';
            document.getElementById(`${testId}-status`).textContent = `✗ FAIL: ${message}`;
            if (details) document.getElementById(`${testId}-details`).textContent = details;
        }
        
        // Test 1: Basic Library Loading
        try {
            const exports = Object.keys(DDOM);
            const hasNewExports = exports.includes('isRequest') && 
                                 exports.includes('createFetchSignal') && 
                                 exports.includes('bindRequestProperty');
            
            if (hasNewExports) {
                pass('test1', 'Library loaded with Request exports', 
                     `Available exports: ${exports.sort().join(', ')}`);
            } else {
                fail('test1', 'Missing Request exports', 
                     `Available exports: ${exports.sort().join(', ')}`);
            }
        } catch (error) {
            fail('test1', 'Library loading failed', error.toString());
        }
        
        // Test 2: Request Detection
        try {
            const testRequest = new Request('https://jsonplaceholder.typicode.com/posts/1');
            const isRequestResult = DDOM.isRequest(testRequest);
            const isNotRequestResult = DDOM.isRequest({ url: 'test' });
            
            if (isRequestResult === true && isNotRequestResult === false) {
                pass('test2', 'Request detection works correctly', 
                     `isRequest(Request): ${isRequestResult}\nisRequest(Object): ${isNotRequestResult}`);
            } else {
                fail('test2', 'Request detection failed', 
                     `isRequest(Request): ${isRequestResult}\nisRequest(Object): ${isNotRequestResult}`);
            }
        } catch (error) {
            fail('test2', 'Request detection error', error.toString());
        }
        
        // Test 3: Simple Fetch Signal
        try {
            const testRequest = new Request('https://jsonplaceholder.typicode.com/posts/1');
            const fetchSignal = DDOM.createFetchSignal(testRequest);
            
            if (fetchSignal && typeof fetchSignal.get === 'function') {
                pass('test3', 'Fetch signal created successfully', 
                     `Signal type: ${fetchSignal.constructor.name}\nInitial value: ${JSON.stringify(fetchSignal.get())}`);
                
                // Monitor the signal for updates
                setTimeout(() => {
                    const result = fetchSignal.get();
                    if (result !== null) {
                        document.getElementById('test3-details').textContent += 
                            `\nFetch completed. Result: ${JSON.stringify(result, null, 2)}`;
                    }
                }, 2000);
            } else {
                fail('test3', 'Fetch signal creation failed', 
                     `Returned: ${typeof fetchSignal}`);
            }
        } catch (error) {
            fail('test3', 'Fetch signal creation error', error.toString());
        }
        
        // Test 4: Declarative Element with Request
        try {
            DDOM.customElements.define({
                tagName: 'test-element',
                testData: new Request('https://jsonplaceholder.typicode.com/posts/1'),
                children: [
                    {
                        tagName: 'div',
                        textContent: 'Request test element created'  
                    }
                ]
            });
            
            const testElement = document.createElement('test-element');
            document.getElementById('test4-demo').appendChild(testElement);
            
            if (testElement.testData && typeof testElement.testData.get === 'function') {
                pass('test4', 'Declarative element with Request property created', 
                     `Element testData type: ${testElement.testData.constructor.name}`);
                
                // Monitor for data
                setTimeout(() => {
                    const data = testElement.testData.get();
                    if (data !== null) {
                        document.getElementById('test4-details').textContent += 
                            `\nElement data loaded: ${JSON.stringify(data, null, 2)}`;
                    }
                }, 3000);
            } else {
                fail('test4', 'Element testData property not converted to signal', 
                     `testData type: ${typeof testElement.testData}`);
            }
        } catch (error) {
            fail('test4', 'Declarative element creation error', error.toString());
        }
        
        console.log('All tests initiated. Check the page for results.');
    </script>
</body>
</html>
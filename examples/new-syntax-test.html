<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Request Syntax Test</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        .test { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .status { padding: 5px; border-radius: 3px; margin: 5px 0; }
        .pass { background: #d4edda; color: #155724; }
        .fail { background: #f8d7da; color: #721c24; }
        .pending { background: #fff3cd; color: #856404; }
        .details { background: #f8f9fa; padding: 10px; border-radius: 3px; margin: 5px 0; font-family: monospace; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>DDOM New Request Syntax Test</h1>
    
    <div class="test">
        <h3>Test 1: New Request Detection</h3>
        <div id="test1-status" class="status pending">Running...</div>
        <div id="test1-details" class="details"></div>
    </div>
    
    <div class="test">
        <h3>Test 2: Request Conversion</h3>
        <div id="test2-status" class="status pending">Running...</div>
        <div id="test2-details" class="details"></div>
    </div>
    
    <div class="test">
        <h3>Test 3: Element Property Binding</h3>
        <div id="test3-status" class="status pending">Running...</div>
        <div id="test3-details" class="details"></div>
    </div>

    <script type="module">
        import DDOM from '../lib/dist/index.js';
        
        function pass(testId, message, details) {
            document.getElementById(`${testId}-status`).className = 'status pass';
            document.getElementById(`${testId}-status`).textContent = `✓ PASS: ${message}`;
            if (details) document.getElementById(`${testId}-details`).textContent = details;
        }
        
        function fail(testId, message, details) {
            document.getElementById(`${testId}-status`).className = 'status fail';
            document.getElementById(`${testId}-status`).textContent = `✗ FAIL: ${message}`;
            if (details) document.getElementById(`${testId}-details`).textContent = details;
        }
        
        // Test 1: New DDOM Request Detection
        try {
            const ddomRequest = {
                Request: {
                    url: "https://jsonplaceholder.typicode.com/posts/1",
                    method: "GET"
                }
            };
            
            const nativeRequest = new Request("https://example.com");
            const plainObject = { url: "test" };
            
            const isNewRequestDetected = DDOM.isRequest(ddomRequest);
            const isNativeRequestDetected = DDOM.isNativeRequest(nativeRequest);
            const isPlainObjectRejected = !DDOM.isRequest(plainObject);
            
            if (isNewRequestDetected && isNativeRequestDetected && isPlainObjectRejected) {
                pass('test1', 'Request detection works correctly', 
                     `DDOM Request: ${isNewRequestDetected}\nNative Request: ${isNativeRequestDetected}\nPlain Object: ${!isPlainObjectRejected}`);
            } else {
                fail('test1', 'Request detection failed', 
                     `DDOM Request: ${isNewRequestDetected}\nNative Request: ${isNativeRequestDetected}\nPlain Object: ${!isPlainObjectRejected}`);
            }
        } catch (error) {
            fail('test1', 'Request detection error', error.toString());
        }
        
        // Test 2: Request Conversion
        try {
            const ddomRequest = {
                Request: {
                    url: "https://jsonplaceholder.typicode.com/posts/1",
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: {
                        title: "Test Post",
                        body: "Test body",
                        userId: 1
                    }
                }
            };
            
            const converted = DDOM.convertDDOMRequestToNative(ddomRequest);
            
            const isRequest = converted instanceof Request;
            const correctUrl = converted.url === "https://jsonplaceholder.typicode.com/posts/1";
            const correctMethod = converted.method === "POST";
            const hasHeaders = converted.headers.get('Content-Type') === 'application/json';
            
            if (isRequest && correctUrl && correctMethod && hasHeaders) {
                pass('test2', 'Request conversion successful', 
                     `URL: ${converted.url}\nMethod: ${converted.method}\nContent-Type: ${converted.headers.get('Content-Type')}`);
            } else {
                fail('test2', 'Request conversion failed', 
                     `isRequest: ${isRequest}\nURL match: ${correctUrl}\nMethod match: ${correctMethod}\nHeaders: ${hasHeaders}`);
            }
        } catch (error) {
            fail('test2', 'Request conversion error', error.toString());
        }
        
        // Test 3: Element Property Binding
        try {
            // Define a custom element with new request syntax
            DDOM.customElements.define({
                tagName: 'test-element',
                $apiData: {
                    Request: {
                        url: "https://jsonplaceholder.typicode.com/posts/1"
                    }
                }
            });
            
            // Create the element
            const testElement = document.createElement('test-element');
            
            // Check if the property was bound correctly
            if (testElement.$apiData && typeof testElement.$apiData.get === 'function') {
                pass('test3', 'Element property binding successful', 
                     `Property type: ${typeof testElement.$apiData}\nHas get method: ${typeof testElement.$apiData.get === 'function'}`);
                
                // Set up a listener to see if data loads
                DDOM.createEffect(() => {
                    const data = testElement.$apiData.get();
                    if (data && !data.error && data.id) {
                        const details = document.getElementById('test3-details');
                        details.textContent += `\nData loaded: ${JSON.stringify(data, null, 2)}`;
                    }
                });
            } else {
                fail('test3', 'Element property binding failed', 
                     `Property type: ${typeof testElement.$apiData}\nProperty value: ${testElement.$apiData}`);
            }
        } catch (error) {
            fail('test3', 'Element property binding error', error.toString());
        }
    </script>
</body>
</html>